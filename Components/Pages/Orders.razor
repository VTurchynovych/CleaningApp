@page "/orders"
@using CleaningApp.Models
@using CleaningApp.Data
@using CleaningApp.Data.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject OrderService _orderService
@inject UserService _userService
@inject ApplicationDbContext _context
@inject IJSRuntime _js
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>📦 Zarządzanie Zleceniami</h3>
    </div>

    <div class="card p-3 mb-4 bg-light border-0 shadow-sm">
        <div class="row g-3 align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0" placeholder="Szukaj (klient, adres, ID)..."
                           @bind="searchText" @bind:event="oninput" @onkeyup="SearchData" />
                </div>
            </div>

            <div class="col-md-3">
                <select class="form-select" @onchange="FilterByStatus">
                    <option value="">Wszystkie statusy</option>
                    @foreach (var status in Enum.GetValues<OrderStatus>())
                    {
                        <option value="@status">@status</option>
                    }
                </select>
            </div>

            <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary me-2" @onclick="ExportToCsv">
                    📂 Eksport CSV
                </button>
                <button class="btn btn-success" @onclick="OpenAddModal">
                    + Dodaj
                </button>
            </div>
        </div>
    </div>

    @if (orders == null)
    {
        <div class="spinner-border text-primary"></div>
    }
    else if (!orders.Any())
    {
        <div class="alert alert-info">Brak zleceń spełniających kryteria.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover align-middle shadow-sm bg-white rounded">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>Klient</th>
                        <th>Adres</th>
                        <th>Usługa</th>
                        <th>Przypisany Pracownik</th>
                        <th>Status</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in orders)
                    {
                        <tr>
                            <td>#@order.Id</td>
                            <td>@order.OrderDate.ToString("dd.MM.yyyy")</td>
                            <td>
                                @(order.Client?.FullName ?? "Brak danych")
                                <br />
                                <small class="text-muted">@order.Client?.Email</small>
                            </td>
                            <td>@order.Address</td>
                            <td>
                                <span class="fw-bold text-primary">@(order.Service?.Name ?? "-")</span>
                            </td>
                            <td>
                                @if (order.Worker != null)
                                {
                                    <span class="badge bg-indigo text-white" style="background-color: #6610f2;">
                                        👷‍♂️ @order.Worker.FullName
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted small fst-italic">Nieprzypisany</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetBadgeClass(order.Status)">@order.Status</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditOrder(order)">
                                    ✏️ Edytuj
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteOrder(order.Id)">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* --- MODAL EDYCJI / DODAWANIA --- *@
@if (showModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="currentOrder" OnValidSubmit="SaveOrder">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Klient</label>
                            <InputSelect class="form-select" @bind-Value="currentOrder.ClientId">
                                <option value="">Wybierz klienta</option>
                                @foreach (var client in allClients)
                                {
                                    <option value="@client.Id">@client.FullName (@client.Email)</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Usługa</label>
                                <InputSelect class="form-select" @bind-Value="currentOrder.ServiceId">
                                    <option value="0">Wybierz</option>
                                    @foreach (var s in allServices)
                                    {
                                        <option value="@s.Id">@s.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data</label>
                                <InputDate class="form-control" @bind-Value="currentOrder.OrderDate" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Adres</label>
                            <InputText class="form-control" @bind-Value="currentOrder.Address" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Uwagi od Klienta</label>
                            <InputTextArea class="form-control" @bind-Value="currentOrder.ClientNote" rows="2" />
                        </div>

                        <hr />

                        <div class="mb-3">
                            <label class="form-label text-danger fw-bold">🔒 Notatki wewnętrzne (Tylko dla pracownika)</label>
                            <InputTextArea class="form-control" @bind-Value="currentOrder.InternalNotes" rows="2"
                                           placeholder="Np. Kod do domofonu, uwagi o psie..." style="background-color: #fff5f5;" />
                            <div class="form-text text-danger">Klient tego nie zobaczy.</div>
                        </div>

                        <div class="mb-3 bg-light p-3 rounded border">
                            <label class="form-label fw-bold text-primary">👷‍♂️ Przypisz pracownika</label>
                            <InputSelect class="form-select" @bind-Value="currentOrder.WorkerId">
                                <option value="">Nieprzypisany (Oczekuje)</option>
                                @foreach (var worker in allWorkers)
                                {
                                    <option value="@worker.Id">@worker.FullName (@worker.Email)</option>
                                }
                            </InputSelect>
                            <div class="form-text">Wybrany pracownik zobaczy to zlecenie w swoim panelu "Moje Zadania".</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect class="form-select" @bind-Value="currentOrder.Status">
                                @foreach (var status in Enum.GetValues<OrderStatus>())
                                {
                                    <option value="@status">@status</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Anuluj</button>
                            <button type="submit" class="btn btn-success">Zapisz zmiany</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Order> orders = new();
    private List<ApplicationUser> allClients = new();
    private List<Service> allServices = new();
    private List<UserViewModel> allWorkers = new();

    private bool showModal = false;
    private string modalTitle = "";
    private Order currentOrder = new();
    private bool isEditing = false;

    private string searchText = "";
    private OrderStatus? statusFilter = null;

    protected override async Task OnInitializedAsync()
    {
        allServices = await _context.Services.ToListAsync();
        allClients = await _context.Users.ToListAsync();

        var usersVM = await _userService.GetAllUsersAsync();
        allWorkers = usersVM.Where(u => u.IsEmployee).ToList();

        await SearchData();
    }

    private async Task SearchData()
    {
        orders = await _orderService.SearchOrdersAsync(searchText, statusFilter);
    }

    private async Task FilterByStatus(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            statusFilter = null;
        }
        else
        {
            statusFilter = Enum.Parse<OrderStatus>(e.Value.ToString());
        }
        await SearchData();
    }

    private void OpenAddModal()
    {
        currentOrder = new Order { OrderDate = DateTime.Today.AddDays(1), Status = OrderStatus.Oczekujące };
        if (allServices.Any()) currentOrder.ServiceId = allServices.First().Id;

        modalTitle = "Nowe Zlecenie";
        isEditing = false;
        showModal = true;
    }

    private void EditOrder(Order order)
    {
        currentOrder = new Order
        {
            Id = order.Id,
            ClientId = order.ClientId,
            WorkerId = order.WorkerId,
            ServiceId = order.ServiceId,
            Address = order.Address,
            OrderDate = order.OrderDate,
            Status = order.Status,
            InternalNotes = order.InternalNotes, 
            ClientNote = order.ClientNote        
        };
        modalTitle = "Edycja Zlecenia #" + order.Id;
        isEditing = true;
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveOrder()
    {
        if (isEditing)
            await _orderService.UpdateOrderAsync(currentOrder);
        else
            await _orderService.AddOrderAsync(currentOrder);

        showModal = false;
        await SearchData();
    }

    private async Task DeleteOrder(int id)
    {
        bool confirmed = await _js.InvokeAsync<bool>("confirm", "Czy na pewno usunąć to zlecenie?");
        if (confirmed)
        {
            await _orderService.DeleteOrderAsync(id);
            await SearchData();
        }
    }

    private async Task ExportToCsv()
    {
        var fileBytes = await _orderService.ExportOrdersToCsvAsync();
        using var stream = new MemoryStream(fileBytes);
        using var streamRef = new DotNetStreamReference(stream);
        await _js.InvokeVoidAsync("downloadFileFromStream", "zlecenia_backup.csv", streamRef);
    }

    private string GetBadgeClass(OrderStatus status) => status switch
    {
        OrderStatus.Oczekujące => "bg-warning text-dark",
        OrderStatus.WTrakcie => "bg-info text-dark",
        OrderStatus.Zakończone => "bg-success",
        OrderStatus.Anulowane => "bg-danger",
        _ => "bg-secondary"
    };
}