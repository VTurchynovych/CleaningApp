@page "/client-services"
@using CleaningApp.Models
@using CleaningApp.Data.Services
@inject ServiceService _serviceService
@inject NavigationManager _nav
@rendermode InteractiveServer

<div class="container mt-5">

    <div class="text-center mb-5">
        <h6 class="text-primary fw-bold text-uppercase">Nasza Oferta</h6>
        <h2 class="fw-bold display-5">Wybierz usługę dla siebie</h2>
        <p class="text-muted lead">Przejrzyste ceny, zero ukrytych kosztów.</p>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="card p-3 shadow-sm border-0 bg-light">
                <div class="row g-3">
                    <div class="col-md-7">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-primary"></i></span>
                            <input type="text" class="form-control border-start-0" placeholder="Szukaj"
                                   @bind="searchText" @bind:event="oninput" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <select class="form-select" @bind="sortOption">
                            <option value="name">Sortuj: Nazwa A-Z</option>
                            <option value="price_asc">Cena: od najniższej</option>
                            <option value="price_desc">Cena: od najwyższej</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (services == null)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>
    }
    else if (!GetFilteredServices().Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-emoji-frown display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">Niestety, nie znaleziono usług pasujących do: "<strong>@searchText</strong>"</h4>
            <button class="btn btn-outline-primary mt-2" @onclick="ClearFilters">Pokaż wszystkie</button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var service in GetFilteredServices())
            {
                <div class="col-md-4">
                    <div class="card service-card h-100 border-0 shadow-sm overflow-hidden">
                        <div class="service-img-wrapper">
                            <img src="@(string.IsNullOrEmpty(service.ImageUrl) ? "/img/default-service.jpg" : service.ImageUrl)"
                                 class="card-img-top service-img"
                                 alt="@service.Name"
                                 onerror="this.src='https://via.placeholder.com/400x250?text=Usluga+Sprzatania'" />
                            <div class="price-tag">
                                @(service.DefaultPrice?.ToString("0.00") ?? "0") zł
                            </div>
                        </div>

                        <div class="card-body p-4 d-flex flex-column">
                            <h4 class="card-title fw-bold mb-3">@service.Name</h4>

                            <div class="mb-3">
                                @if (!string.IsNullOrEmpty(service.EstimatedTime))
                                {
                                    <div class="d-flex align-items-center text-muted mb-1">
                                        <i class="bi bi-clock-history me-2 text-primary"></i>
                                        <small>Czas: <strong>@service.EstimatedTime</strong></small>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(service.AreaRange))
                                {
                                    <div class="d-flex align-items-center text-muted mb-1">
                                        <i class="bi bi-arrows-fullscreen me-2 text-primary"></i>
                                        <small>Metraż: <strong>@service.AreaRange</strong></small>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(service.Includes))
                                {
                                    <div class="d-flex align-items-start text-muted mb-1">
                                        <i class="bi bi-check-circle-fill me-2 text-success mt-1" style="font-size: 0.8rem;"></i>
                                        <small class="lh-sm">@service.Includes</small>
                                    </div>
                                }
                            </div>

                            <p class="card-text text-muted flex-grow-1 border-top pt-3 mt-2" style="font-size: 0.9rem;">
                                @(service.Description ?? "Profesjonalne wykonanie z gwarancją jakości.")
                            </p>

                            <div class="mt-auto">
                                <hr class="my-3" style="opacity: 0.1" />
                                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-hover"
                                        @onclick="() => BookService(service.Id)">
                                    Zamów teraz <i class="bi bi-arrow-right-short"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .service-card {
        transition: transform 0.3s, box-shadow 0.3s;
        border-radius: 15px;
    }

        .service-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
        }

    .service-img-wrapper {
        position: relative;
        overflow: hidden;
        height: 220px;
        border-radius: 15px 15px 0 0;
    }

    .service-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .service-card:hover .service-img {
        transform: scale(1.1);
    }

    .price-tag {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: white;
        color: var(--primary-color);
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .shadow-hover {
        transition: all 0.3s;
    }

        .shadow-hover:hover {
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
            transform: scale(1.02);
        }
</style>

@code {
    private List<Service> services;

    // Zmienne do filtrowania
    private string searchText = "";
    private string sortOption = "name";

    protected override async Task OnInitializedAsync()
    {
        services = await _serviceService.GetServicesAsync();
    }

    private IEnumerable<Service> GetFilteredServices()
    {
        if (services == null) return Enumerable.Empty<Service>();

        var query = services.AsEnumerable();

        // 1. Wyszukiwanie (po nazwie LUB opisie)
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(s =>
                s.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (s.Description != null && s.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            );
        }

        // 2. Sortowanie
        query = sortOption switch
        {
            "price_asc" => query.OrderBy(s => s.DefaultPrice),
            "price_desc" => query.OrderByDescending(s => s.DefaultPrice),
            _ => query.OrderBy(s => s.Name)
        };

        return query;
    }

    private void ClearFilters()
    {
        searchText = "";
        sortOption = "name";
    }

    private void BookService(int serviceId)
    {
        _nav.NavigateTo($"/client-dashboard?serviceId={serviceId}");
    }
}